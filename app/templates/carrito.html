{% if carrito_view %}
    <div class="container mt-5">
        <h2>Carrito de Compras</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if carritos %}
            <table class="table table-striped mt-3" id="carrito-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in carritos %}
                        {% set producto = Producto.query.get(item.producto_idproducto) %}
                        <tr data-item-id="{{ item.idcarrito }}">
                            <td>{{ producto.nombre }}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary decrease-qty" data-item-id="{{ item.idcarrito }}">-</button>
                                <span class="qty" id="qty-{{ item.idcarrito }}">{{ item.cantidad }}</span>
                                <button class="btn btn-sm btn-secondary increase-qty" data-item-id="{{ item.idcarrito }}">+</button>
                            </td>
                            <td class="subtotal" id="subtotal-{{ item.idcarrito }}">{{ formatCurrency(item.cantidad * producto.precio_unitario) }}</td>
                            <td>
                                <form action="{{ url_for('carrito.eliminar_del_carrito', carrito_id=item.idcarrito) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h4 class="mt-3">Total: <span id="total-display">{{ total_formateado }}</span></h4>

            <h3 class="mt-4">Realizar Pago</h3>
            <form action="{{ url_for('carrito.realizar_pago') }}" method="POST" class="mt-3">
                <input type="hidden" name="total" id="total-input" value="{{ total|float }}">
                <input type="hidden" name="carrito_items" id="carrito-items-input" value="{{ carritos|tojson }}">

                <div class="mb-3">
                    <label for="fecha_pago" class="form-label">Fecha de Pago</label>
                    <input type="date" class="form-control" id="fecha_pago" name="fecha_pago" value="{{ request.form.get('fecha_pago', '') }}" required>
                </div>
                <div class="mb-3">
                    <label for="metodo_pago" class="form-label">Método de Pago</label>
                    <select class="form-select" id="metodo_pago" name="metodo_pago" required>
                        <option value="tarjeta">Tarjeta</option>
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="mixto">Pago Mixto</option>
                    </select>
                </div>
                <div id="pago_mixto_fields" style="display: none;">
                    <h5>Montos por Método</h5>
                    <div class="mb-3">
                        <label for="monto_efectivo" class="form-label">Efectivo</label>
                        <input type="number" class="form-control monto-input" id="monto_efectivo" name="monto_efectivo" step="0.01" min="0" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="monto_tarjeta" class="form-label">Tarjeta</label>
                        <input type="number" class="form-control monto-input" id="monto_tarjeta" name="monto_tarjeta" step="0.01" min="0" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="monto_transferencia" class="form-label">Transferencia</label>
                        <input type="number" class="form-control monto-input" id="monto_transferencia" name="monto_transferencia" step="0.01" min="0" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="monto_otro" class="form-label">Otro</label>
                        <input type="number" class="form-control monto-input" id="monto_otro" name="monto_otro" step="0.01" min="0" value="0">
                        <input type="text" class="form-control mt-2" id="descripcion_otro" name="descripcion_otro" placeholder="Descripción del otro método">
                    </div>
                    <div class="mb-3">
                        <strong>Total Pagado: <span id="total_pagado">0.00</span></strong><br>
                        <strong>Resto a Pagar: <span id="resto_pagar">{{ total_formateado }}</span></strong>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="referencia_pago" class="form-label">Referencia de Pago</label>
                    <input type="text" class="form-control" id="referencia_pago" name="referencia_pago" value="{{ request.form.get('referencia_pago', '') }}">
                </div>
                <div class="mb-3">
                    <label for="estado_pago" class="form-label">Estado de Pago</label>
                    <select class="form-select" id="estado_pago" name="estado_pago" required>
                        <option value="pendiente">Pendiente</option>
                        <option value="completado">Completado</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="proveedor_pago" class="form-label">Proveedor de Pago</label>
                    <input type="text" class="form-control" id="proveedor_pago" name="proveedor_pago" value="{{ request.form.get('proveedor_pago', '') }}">
                </div>
                <div class="mb-3">
                    <label for="token_transaccion" class="form-label">Token de Transacción</label>
                    <input type="text" class="form-control" id="token_transaccion" name="token_transaccion" value="{{ request.form.get('token_transaccion', '') }}">
                </div>
                <button type="submit" class="btn btn-success w-100">Realizar Pago</button>
            </form>
        {% else %}
            <p class="text-center">El carrito está vacío.</p>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function formatCurrency(value) {
            return '$ ' + value.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const items = document.querySelectorAll('#carrito-table tbody tr');
            let total = parseFloat(document.getElementById('total-input').value);

            // Manejar cambio de método de pago
            document.getElementById('metodo_pago').addEventListener('change', function() {
                const pagoMixtoFields = document.getElementById('pago_mixto_fields');
                if (this.value === 'mixto') {
                    pagoMixtoFields.style.display = 'block';
                    updatePagoMixto();
                } else {
                    pagoMixtoFields.style.display = 'none';
                }
            });

            // Manejar cambios en montos de pago mixto
            document.querySelectorAll('.monto-input').forEach(input => {
                input.addEventListener('input', updatePagoMixto);
            });

            function updatePagoMixto() {
                const efectivo = parseFloat(document.getElementById('monto_efectivo').value) || 0;
                const tarjeta = parseFloat(document.getElementById('monto_tarjeta').value) || 0;
                const transferencia = parseFloat(document.getElementById('monto_transferencia').value) || 0;
                const otro = parseFloat(document.getElementById('monto_otro').value) || 0;
                const totalPagado = efectivo + tarjeta + transferencia + otro;
                const resto = total - totalPagado;

                document.getElementById('total_pagado').textContent = formatCurrency(totalPagado);
                document.getElementById('resto_pagar').textContent = formatCurrency(resto);
            }

            items.forEach(item => {
                const itemId = item.getAttribute('data-item-id');
                const qtyElement = document.getElementById(`qty-${itemId}`);
                const subtotalElement = document.getElementById(`subtotal-${itemId}`);
                const increaseBtn = item.querySelector('.increase-qty');
                const decreaseBtn = item.querySelector('.decrease-qty');
                const precioUnitario = parseFloat(subtotalElement.textContent.replace('$', '').replace(',', '')) / parseInt(qtyElement.textContent);

                increaseBtn.addEventListener('click', function() {
                    let qty = parseInt(qtyElement.textContent);
                    qty += 1;
                    qtyElement.textContent = qty;
                    const newSubtotal = qty * precioUnitario;
                    subtotalElement.textContent = formatCurrency(newSubtotal);
                    updateTotal();
                    updateHiddenInputs();
                    updatePagoMixto();
                });

                decreaseBtn.addEventListener('click', function() {
                    let qty = parseInt(qtyElement.textContent);
                    if (qty > 1) {
                        qty -= 1;
                        qtyElement.textContent = qty;
                        const newSubtotal = qty * precioUnitario;
                        subtotalElement.textContent = formatCurrency(newSubtotal);
                        updateTotal();
                        updateHiddenInputs();
                        updatePagoMixto();
                    }
                });
            });

            function updateTotal() {
                let newTotal = 0;
                document.querySelectorAll('.subtotal').forEach(subtotal => {
                    newTotal += parseFloat(subtotal.textContent.replace('$', '').replace(',', ''));
                });
                document.getElementById('total-display').textContent = formatCurrency(newTotal);
                document.getElementById('total-input').value = newTotal.toFixed(2);
                total = newTotal;
                updatePagoMixto();
            }

            function updateHiddenInputs() {
                const items = [];
                document.querySelectorAll('#carrito-table tbody tr').forEach(row => {
                    const itemId = row.getAttribute('data-item-id');
                    const qty = parseInt(document.getElementById(`qty-${itemId}`).textContent);
                    items.push({ id: itemId, cantidad: qty });
                });
                document.getElementById('carrito-items-input').value = JSON.stringify(items);
            }
        });
    </script>
</body>
</html>