{% extends "plantilla.html" %}

{% block title %}Panel Administrativo - JDNS Comunicaciones{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-primary-custom">
            <i class="bi bi-shield-check me-2"></i>Panel Administrativo
        </h1>
        <button class="btn btn-primary-custom" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAdmin"
            aria-controls="offcanvasAdmin">
            <i class="bi bi-list me-2"></i>Opciones Administración
        </button>
    </div>

    <!-- Offcanvas Panel -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasAdmin" aria-labelledby="offcanvasAdminLabel">
        <div class="offcanvas-header bg-primary-custom text-white">
            <h5 class="offcanvas-title" id="offcanvasAdminLabel">
                <i class="bi bi-gear me-2"></i>Panel de Administración
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                aria-label="Cerrar"></button>
        </div>
        <div class="offcanvas-body">
            <div class="mb-3">
                <h6 class="text-primary-custom fw-bold">
                    <i class="bi bi-building me-2"></i>Gestión Empresarial
                </h6>
                <ul class="list-group list-group-flush mb-3">
                    <li class="list-group-item"><a href="{{ url_for('empresa.listar') }}" class="text-decoration-none">
                            <i class="bi bi-building me-2"></i>Empresas</a></li>
                    <li class="list-group-item"><a href="{{ url_for('producto.listar_productos') }}"
                            class="text-decoration-none">
                            <i class="bi bi-box-seam me-2"></i>Productos</a></li>
                </ul>
            </div>

            <div class="mb-3">
                <h6 class="text-primary-custom fw-bold">
                    <i class="bi bi-people me-2"></i>Gestión de Usuarios
                </h6>
                <ul class="list-group list-group-flush mb-3">
                    <li class="list-group-item"><a href="{{ url_for('auth.register_admin') }}"
                            class="text-decoration-none">
                            <i class="bi bi-person-plus me-2"></i>Usuarios</a></li>
                    <li class="list-group-item"><a href="{{ url_for('mensaje_soporte.mensajes_soporte') }}"
                            class="text-decoration-none">
                            <i class="bi bi-chat-dots me-2"></i>Mensajes de Soporte</a></li>
                    <li class="list-group-item"><a href="{{ url_for('notificaciones.notificaciones') }}"
                            class="text-decoration-none">
                            <i class="bi bi-bell me-2"></i>Notificaciones</a></li>
                </ul>
            </div>

            <div class="mb-3">
                <h6 class="text-primary-custom fw-bold">
                    <i class="bi bi-cash me-2"></i>Gestión Financiera
                </h6>
                <ul class="list-group list-group-flush mb-3">
                    <li class="list-group-item"><a href="{{ url_for('pago.listar_pedidos') }}"
                            class="text-decoration-none">
                            <i class="bi bi-credit-card me-2"></i>Pagos</a></li>
                    <li class="list-group-item"><a href="{{ url_for('ventas_factura.listar_ventas') }}"
                            class="text-decoration-none">
                            <i class="bi bi-receipt me-2"></i>Facturas</a></li>
                </ul>
            </div>

            <div class="mb-3">
                <h6 class="text-primary-custom fw-bold">
                    <i class="bi bi-tools me-2"></i>Gestión Técnica
                </h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><a href="{{ url_for('dispositivo.nuevo_dispositivo') }}"
                            class="text-decoration-none">
                            <i class="bi bi-device me-2"></i>Dispositivos</a></li>
                    <li class="list-group-item"><a href="{{ url_for('reparacion.listar_reparaciones') }}"
                            class="text-decoration-none">
                            <i class="bi bi-wrench me-2"></i>Reparaciones</a></li>
                    <li class="list-group-item"><a href="{{ url_for('historial_reparacion.listar_todos') }}"
                            class="text-decoration-none">
                            <i class="bi bi-clock-history me-2"></i>Historial</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="container">
        


        <!-- Actualizar Costo de Reparación -->
        <button class="btn btn-primary-custom btn-lg" onclick="toggleVentaFisica()">
            <i class="bi bi-cart-plus me-2"></i>Nueva Venta Física
        </button>
        <div id="ventaFisicaForm" style="display:none;">
            <div class="row">
                <div class="col-lg-7 mb-4">
                    <div class="card">
                        <div class="card-header">Seleccionar Productos</div>
                        <div class="card-body">
                            <input id="buscarProducto" class="form-control mb-3" placeholder="Buscar producto...">
                            <div class="row" id="productosDisponibles">
                                {% for p in productos %}
                                <div class="col-6 mb-2">
                                    <div class="card producto-item" data-id="{{ p.idproducto }}"
                                        data-nombre="{{ p.nombre|e }}" data-precio="{{ p.precio_unitario }}"
                                        data-stock="{{ p.stock }}">
                                        <div class="card-body p-0 text-center">
                                            <h6 class="card-title">{{ p.nombre }}</h6>
                                            <p class="text-muted small mb-1">Stock: {{ p.stock }}</p>
                                            <strong class="text-success">${{ p.precio_unitario }}</strong>
                                            <div class="mt-1"><button
                                                    class="agregar-producto btn btn-sm btn-primary">Agregar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header">
                            <h5>Carrito de Venta</h5>
                        </div>
                        <div class="card-body">
                            <div id="carrito-items">
                                <p class="text-muted">No hay productos seleccionados</p>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-6"><strong>Subtotal:</strong></div>
                                <div class="col-6 text-end"><span id="subtotal-amount">$0.00</span></div>
                            </div>
                            <div class="row">
                                <div class="col-6"><strong>IVA (19%):</strong></div>
                                <div class="col-6 text-end"><span id="iva-amount">$0.00</span></div>
                            </div>
                            <div class="row border-top pt-2 mt-2">
                                <div class="col-6"><strong>Total:</strong></div>
                                <div class="col-6 text-end"><strong id="total-amount">$0.00</strong></div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Nombre cliente (opcional)</label>
                                <input id="cliente-nombre" class="form-control mb-2" placeholder="Nombre del cliente">
                                <label class="form-label">Correo (opcional)</label>
                                <input id="cliente-correo" class="form-control mb-2" placeholder="Correo del cliente">
                                <label class="form-label">Teléfono (opcional)</label>
                                <input id="cliente-telefono" class="form-control mb-2"
                                    placeholder="Teléfono del cliente">
                                <label class="form-label">Dirección (opcional)</label>
                                <input id="cliente-direccion" class="form-control mb-2"
                                    placeholder="Dirección del cliente">
                                <label class="form-label">Método de Pago</label>
                                <select id="metodo-pago" class="form-select">
                                    <option value="efectivo">Efectivo</option>
                                    <option value="tarjeta">Tarjeta</option>
                                    <option value="transferencia">Transferencia</option>
                                    <option value="mixto">Mixto</option>
                                </select>
                            </div>
                            <button id="procesar-venta" class="btn btn-success w-100 mt-3">Procesar Venta</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones rápidas -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card shadow-custom text-center h-100">
                <div class="card-body">
                    <div class="display-4 text-primary-custom mb-2">
                        <i class="bi bi-receipt"></i>
                    </div>
                    <h5 class="card-title">Facturas / Ventas</h5>
                    <p class="card-text text-muted">Ver y gestionar facturas</p>
                    <a href="{{ url_for('ventas_factura.listar_ventas') }}" class="btn btn-primary-custom">Ver
                        Facturas</a>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card shadow-custom text-center h-100">
                <div class="card-body">
                    <div class="display-4 text-success mb-2">
                        <i class="bi bi-box-seam"></i>
                    </div>
                    <h5 class="card-title">Productos</h5>
                    <p class="card-text text-muted">Lista de productos</p>
                    <a href="{{ url_for('producto.listar_productos') }}" class="btn btn-success">Ver Productos</a>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card shadow-custom text-center h-100">
                <div class="card-body">
                    <div class="display-4 text-info mb-2">
                        <i class="bi bi-people"></i>
                    </div>
                    <h5 class="card-title">Usuarios</h5>
                    <p class="card-text text-muted">Gestionar administradores</p>
                    <a href="{{ url_for('auth.register_admin') }}" class="btn btn-info text-white">Ver Usuarios</a>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card shadow-custom text-center h-100">
                <div class="card-body">
                    <div class="display-4 text-warning mb-2">
                        <i class="bi bi-cash"></i>
                    </div>
                    <h5 class="card-title">Pagos</h5>
                    <p class="card-text text-muted">Revisar pagos</p>
                    <a href="{{ url_for('pago.listar_pedidos') }}" class="btn btn-warning text-white">Ver Pagos</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Gestión Técnica -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card shadow-custom text-center h-100">
                <div class="card-body">
                    <div class="display-4 text-danger mb-2">
                        <i class="bi bi-device"></i>
                    </div>
                    <h5 class="card-title">Dispositivos</h5>
                    <p class="card-text text-muted">Gestionar dispositivos</p>
                    <a href="{{ url_for('dispositivo.nuevo_dispositivo') }}" class="btn btn-danger">Ver Dispositivos</a>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card shadow-custom text-center h-100">
                <div class="card-body">
                    <div class="display-4 text-secondary mb-2">
                        <i class="bi bi-wrench"></i>
                    </div>
                    <h5 class="card-title">Reparaciones</h5>
                    <p class="card-text text-muted">Lista de reparaciones</p>
                    <a href="{{ url_for('reparacion.listar_reparaciones') }}" class="btn btn-secondary">Ver
                        Reparaciones</a>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card shadow-custom text-center h-100">
                <div class="card-body">
                    <div class="display-4 text-dark mb-2">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <h5 class="card-title">Historial</h5>
                    <p class="card-text text-muted">Ver historial admin</p>
                    <a href="{{ url_for('historial_reparacion.listar_todos') }}" class="btn btn-dark">Ver Historial</a>
                </div>
            </div>
        </div>
    </div>

   
    

    
<style>
.producto-item {
    max-height: 120px;
    overflow: hidden;
}
.producto-item .card-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
</style>
</div>

{% block extra_js %}
<script>
    // JS para seleccionar productos y manejar carrito en el panel admin
    document.addEventListener('DOMContentLoaded', function () {
        const buscarInput = document.getElementById('buscarProducto');
        if (buscarInput) {
            buscarInput.addEventListener('input', () => {
                const term = buscarInput.value.toLowerCase();
                document.querySelectorAll('.producto-item').forEach(card => {
                    const title = card.querySelector('.card-title').textContent.toLowerCase();
                    card.parentElement.style.display = title.includes(term) ? 'block' : 'none';
                });
            });
        }

        let carrito = [];

        function actualizarCarritoDOM() {
            const carritoDiv = document.getElementById('carrito-items');
            carritoDiv.innerHTML = '';
            let total_base = 0;
            carrito.forEach((item, index) => {
                const itemSubtotal = item.precio * item.cantidad;
                total_base += itemSubtotal;
                const el = document.createElement('div');
                el.className = 'carrito-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                el.innerHTML = `
                <div><strong>${item.nombre}</strong><br><small>$${item.precio.toFixed(2)} x ${item.cantidad} = $${itemSubtotal.toFixed(2)}</small></div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="window.__cambiarCantidad(${index}, -1)">-</button>
                    <button class="btn btn-outline-secondary" onclick="window.__cambiarCantidad(${index}, 1)">+</button>
                    <button class="btn btn-outline-danger" onclick="window.__eliminarItem(${index})">×</button>
                </div>`;
                carritoDiv.appendChild(el);
            });
            if (!carrito.length) carritoDiv.innerHTML = '<p class="text-muted">No hay productos seleccionados</p>';
            const subtotal = total_base * 0.81;
            const iva = total_base * 0.19;
            const total = total_base;
            document.getElementById('subtotal-amount').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('iva-amount').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('total-amount').textContent = `$${total.toFixed(2)}`;
        }

        window.__cambiarCantidad = function (index, cambio) {
            const item = carrito[index];
            if (!item) return;
            const nueva = item.cantidad + cambio;
            if (nueva <= 0) carrito.splice(index, 1);
            else if (nueva <= item.stock) item.cantidad = nueva;
            actualizarCarritoDOM();
        };

        window.__eliminarItem = function (index) {
            carrito.splice(index, 1);
            actualizarCarritoDOM();
        };

        // Manejo de botones "Agregar"
        document.querySelectorAll('.agregar-producto').forEach(btn => {
            btn.addEventListener('click', function () {
                const card = this.closest('.producto-item');
                const producto = {
                    id: card.dataset.id,
                    nombre: card.dataset.nombre,
                    precio: parseFloat(card.dataset.precio) || 0,
                    stock: parseInt(card.dataset.stock) || 0,
                    cantidad: 1
                };
                const existente = carrito.find(x => x.id === producto.id);
                if (existente) {
                    if (existente.cantidad < producto.stock) existente.cantidad += 1;
                    else return alert('Sin stock');
                } else carrito.push(producto);
                actualizarCarritoDOM();
            });
        });

        // Toggle form
        window.toggleVentaFisica = function () {
            const f = document.getElementById('ventaFisicaForm');
            if (!f) return;
            f.style.display = f.style.display === 'none' ? 'block' : 'none';
        };

        // Procesar venta: enviamos al backend para crear la factura
        const procesarBtn = document.getElementById('procesar-venta');
        if (procesarBtn) {
            procesarBtn.addEventListener('click', async () => {
                if (!carrito.length) return alert('No hay productos en el carrito');
                const metodo = document.getElementById('metodo-pago').value;
                const clienteNombre = document.getElementById('cliente-nombre').value || null;
                const clienteCorreo = document.getElementById('cliente-correo').value || null;
                const clienteTelefono = document.getElementById('cliente-telefono').value || null;
                const clienteDireccion = document.getElementById('cliente-direccion').value || null;

                // Construir payload
                const total_base = carrito.reduce((s, it) => s + it.precio * it.cantidad, 0);
                const total = parseFloat(total_base.toFixed(2));

                try {
                    const resp = await fetch("{{ url_for('ventas_factura.venta_fisica') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            productos: carrito.map(i => ({ id: parseInt(i.id), cantidad: i.cantidad })),
                            metodo_pago: metodo,
                            cliente_nombre: clienteNombre,
                            cliente_correo: clienteCorreo,
                            cliente_telefono: clienteTelefono,
                            cliente_direccion: clienteDireccion,
                            total: total
                        })
                    });
                    const json = await resp.json();
                    if (!resp.ok) return alert(json.error || 'Error al crear la factura');

                    // Redirigir al detalle de la factura
                    const id = json.factura_id;
                    if (id) {
                        window.location.href = `{{ url_for('ventas_factura.detalle_venta', id=0) }}`.replace('/0', '/' + id);
                    } else {
                        alert('Factura creada, pero id no devuelto');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error de comunicación con el servidor');
                }
            });
        }
    });
</script>
{% endblock %}

{% endblock %}
