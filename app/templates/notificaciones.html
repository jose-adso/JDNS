
{% extends "plantilla.html" %}
{% block title %}Notificaciones{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Notificaciones</h2>
    <div class="list-group">
        {% for noti in notificaciones %}
            <div class="list-group-item d-flex justify-content-between align-items-center {% if not noti.leido %}list-group-item-warning{% endif %}">
                <div>
                    <h6 class="mb-1">{{ noti.tipo }}</h6>
                    <p class="mb-1">{{ noti.mensaje }}</p>
                    <small class="text-muted">{{ noti.fecha_envio }}</small>
                </div>
                <div>
                    {% if not noti.leido %}
                        <button class="btn btn-sm btn-success marcar-leida" data-id="{{ noti.id }}">Marcar leída</button>
                        <span class="badge bg-danger">Nuevo</span>
                    {% else %}
                        <span class="badge bg-secondary">Leída</span>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <div class="list-group-item text-center text-muted">
                No hay notificaciones
            </div>
        {% endfor %}
    </div>
</div>

<!-- Alertas Bootstrap (Flask flash messages) -->
<div class="container mt-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show shadow" role="alert">
                    <i class="bi bi-bell-fill me-2"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
    const botones = document.querySelectorAll('.marcar-leida');

    botones.forEach(btn=>{
        btn.addEventListener('click', async ()=>{
            const id = btn.dataset.id;
            try{
                // Llamada al endpoint Flask para marcar como leída
                await fetch(`{{ url_for('notificaciones.marcar_leida', id=0) }}`.replace('/0', `/${id}`), { 
                    method:'POST', 
                    credentials:'same-origin' 
                });

                // Actualizar visualmente el item
                btn.closest('.list-group-item').classList.remove('list-group-item-warning');
                const badge = btn.closest('.list-group-item').querySelector('.badge');
                if(badge){ 
                    badge.classList.remove('bg-danger'); 
                    badge.classList.add('bg-secondary'); 
                    badge.textContent = "Leída"; 
                }
                btn.remove();

                // Actualizar el badge del navbar
                updateNavbarBadge();
            }catch(err){
                console.error('Error marcando como leída', err);
            }
        });
    });

    // Actualiza el badge rojo de la campana en el navbar
    function updateNavbarBadge(){
        const badgeEl = document.getElementById('client-noti-badge');
        if(badgeEl){
            const unread = document.querySelectorAll('.list-group-item-warning').length;
            if(unread > 0){
                badgeEl.style.display = 'inline-block';
                badgeEl.textContent = unread;
            } else {
                badgeEl.style.display = 'none';
            }
        }
    }

    // Inicializar badge al cargar
    updateNavbarBadge();
});
</script>
{% endblock %}
```
